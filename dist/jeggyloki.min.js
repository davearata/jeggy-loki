var _get=require("babel-runtime/helpers/get")["default"],_inherits=require("babel-runtime/helpers/inherits")["default"],_createClass=require("babel-runtime/helpers/create-class")["default"],_classCallCheck=require("babel-runtime/helpers/class-call-check")["default"],_Promise=require("babel-runtime/core-js/promise")["default"];!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jeggy"),require("lodash"),require("lokijs")):"function"==typeof define&&define.amd?define(["exports","jeggy","lodash","lokijs"],t):t(e.jeggyloki={},e.jeggy,e._,e.Loki)}(this,function(e,t,i,n){"use strict";i="default"in i?i["default"]:i,n="default"in n?n["default"]:n;var r=function(e){if(i.keys(e).length>1){var t=i.map(i.keys(e),function(t){var i={};return i[t]=e[t],i});e={$and:t}}return e},o=function(e,t){var i={};return i[e]=t,i},l=function(e,t){var n={},r=t.split(" ");return i.includes(t,"-")?(n=i.assign(n,e),i.each(r,function(e){i.includes(e,"-")&&(e=i.trim(e,"-"),n=i.omit(n,e))})):i.each(r,function(t){i.includes(t,"+")&&(t=i.trim(t,"+")),n[t]=e[t]}),n},u=function(e){function t(e,i,n){if(_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),!i)throw new Error("a LokiCollection must be intiialized with a native lokiJS collection");this.nativeLokiCollection=i,this.idKey=n||"_id"}return _inherits(t,e),_createClass(t,[{key:"find",value:function(e,t){var n=this.nativeLokiCollection;return new _Promise(function(o,u){try{e=r(e),i.isUndefined(e)&&(e={});var a=n.find(e);null!==a&&(a=i.clone(a,!0),i.isString(t)&&(a=i.map(a,function(e){return l(e,t)}))),o(a)}catch(s){u(s)}})}},{key:"findOne",value:function(e,t){var n=this.nativeLokiCollection;return new _Promise(function(o,u){try{e=r(e),i.isUndefined(e)&&(e={});var a=n.find(e);if(null===a||i.isEmpty(a))return o(null);i.isArray(a)&&(a=a[0]),a=i.assign({},a),i.isString(t)&&i.isObject(a)&&(a=l(a,t)),o(a)}catch(s){u(s)}})}},{key:"findById",value:function(e,t){var i=o(this.idKey,e);return this.findOne(i,t)}},{key:"create",value:function(e){var t=this.nativeLokiCollection;return new _Promise(function(n,r){try{var o=t.insert(e);if(null===o)return n(o);n(i.assign({},o))}catch(l){r(l)}})}},{key:"removeWhere",value:function(e){var t=this.nativeLokiCollection;return new _Promise(function(i,n){try{e=r(e),i(t.removeWhere(e))}catch(o){n(o)}})}},{key:"remove",value:function(e){var t=this.nativeLokiCollection,n=o(this.idKey,e[this.idKey]);return new _Promise(function(r,o){try{var l=i.assign({},t.findOne(n));if(i.isEmpty(l))throw new Error("unknown doc id:"+e.id);r(t.remove(e))}catch(u){o(u)}})}},{key:"update",value:function(e){var t=this.nativeLokiCollection,n=o(this.idKey,e[this.idKey]);return this.findOne(n).then(function(n){if(i.isEmpty(n))throw new Error("unknown doc id:"+e.id);return n=i.assign(n,e),t.update(n),i.assign({},n)})}}]),t}(t.Collection);e.LokiCollection=u;var a=function(e,t,n){var r=e[t];if(i.isUndefined(r)||i.isNull(r))return _Promise.resolve();if(i.isArray(r)){var o=function(){var o=r,l=[],u=i.map(o,function(e){return n.findById(e).then(function(e){if(!e)throw new Error("population  failed");l.push(e)})});return{v:_Promise.all(u).then(function(){return e[t]=l,e})}}();if("object"==typeof o)return o.v}return n.findById(r).then(function(i){if(!i)throw new Error("population  failed");e[t]=i})},s=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),i.isString(e)&&(e=new n(e)),this.loki=e,this.collections={}}return _inherits(t,e),_createClass(t,[{key:"addCollection",value:function(e,t){var n=void 0;if(e instanceof u)n=e,e=n.name;else{if(!i.isString(e)||i.isEmpty(e))throw new Error("must provide a name when adding a collection");var r=this.loki.addCollection(e);n=new u(e,r,t)}return this.collections[e]=n,n}},{key:"getCollection",value:function(e){if(!this.collections[e])throw new Error("unknown collection: "+e);return this.collections[e]}},{key:"getCollections",value:function(){return this.collections}},{key:"populate",value:function(e,t,n){var r=this;try{var o=function(){if(!e)return{v:_Promise.reject(new Error("tried to populate a null value"))};var o=r.getCollection(n);i.isArray(e)||(e=[e]);var l=i.map(e,function(e){return a(e,t,o)});return{v:_Promise.all(l).then(function(){return e})}}();if("object"==typeof o)return o.v}catch(l){return _Promise.reject(l)}}}]),t}(t.Adapter);e.LokiAdapter=s});
//# sourceMappingURL=jeggyloki.min.js.map
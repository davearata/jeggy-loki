var _get=require("babel-runtime/helpers/get")["default"],_inherits=require("babel-runtime/helpers/inherits")["default"],_createClass=require("babel-runtime/helpers/create-class")["default"],_classCallCheck=require("babel-runtime/helpers/class-call-check")["default"],_Promise=require("babel-runtime/core-js/promise")["default"];!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("jeggy"),require("lodash"),require("lokijs")):"function"==typeof define&&define.amd?define(["exports","jeggy","lodash","lokijs"],n):n(e.jeggyloki={},e.jeggy,e._,e.Loki)}(this,function(e,n,t,i){"use strict";t="default"in t?t["default"]:t,i="default"in i?i["default"]:i;var r=function(e,n){if(e=t.reduce(e,function(e,i,r){return t.contains(n,r)?t.isArray(i)?e[r]={$containsAny:i}:e[r]={$contains:i}:e[r]=i,e},{}),t.keys(e).length>1){var i=t.map(t.keys(e),function(n){var t={};return t[n]=e[n],t});e={$and:i}}return e},o=function(e,n){var t={};return t[e]=n,t},u=function(e,n){var i={},r=n.split(" ");return t.includes(n,"-")?(i=t.assign(i,e),t.each(r,function(e){t.includes(e,"-")&&(e=t.trim(e,"-"),i=t.omit(i,e))})):t.each(r,function(n){t.includes(n,"+")&&(n=t.trim(n,"+")),i[n]=e[n]}),i},a=function(e){function n(e,t,i,r){if(_classCallCheck(this,n),_get(Object.getPrototypeOf(n.prototype),"constructor",this).call(this,e),!t)throw new Error("a LokiCollection must be intiialized with a native lokiJS collection");this.nativeLokiCollection=t,this.idKey=i||"_id",this.arrayKeys=r}return _inherits(n,e),_createClass(n,[{key:"find",value:function(e,n){var i=this.nativeLokiCollection,o=this.arrayKeys;return new _Promise(function(a,s){try{e=r(e,o),t.isUndefined(e)&&(e={});var l=i.find(e);null!==l&&(t.isString(n)&&(l=t.map(l,function(e){return u(e,n)})),l=t.clone(l,!0)),a(l)}catch(c){s(c)}})}},{key:"findStream",value:function(){throw new Error("jeggy-loki does not yet support this functionality")}},{key:"findOne",value:function(e,n){return this.find(e,n).then(function(e){return t.isArray(e)&&(e=e[0]),e})}},{key:"findById",value:function(e,n){var t=o(this.idKey,e);return this.findOne(t,n)}},{key:"create",value:function(e){var n=this.nativeLokiCollection;return new _Promise(function(i,r){try{var o=n.insert(e);if(null===o)return i(o);i(t.assign({},o))}catch(u){r(u)}})}},{key:"insertMany",value:function(e){var n=this.nativeLokiCollection;return new _Promise(function(i,r){try{var o=n.insert(e);if(null===o)return i(o);i(t.clone(o,!0))}catch(u){r(u)}})}},{key:"removeWhere",value:function(e){var n=this.nativeLokiCollection,t=this.arrayKeys;return new _Promise(function(i,o){try{e=r(e,t),i(n.removeWhere(e))}catch(u){o(u)}})}},{key:"remove",value:function(e){var n=this.nativeLokiCollection,i=o(this.idKey,e[this.idKey]);return new _Promise(function(r,o){try{var u=t.assign({},n.findOne(i));t.isEmpty(u)&&o(new Error("unknown doc id:"+e.id)),r(n.remove(e))}catch(a){o(a)}})}},{key:"update",value:function(e){var n=this.nativeLokiCollection,i=this.idKey,r=o(i,e[i]);return this.findOne(r).then(function(r){if(t.isEmpty(r))throw new Error("unknown doc id: "+e[i]);return r=t.assign(r,e),n.update(r),t.assign({},r)})}},{key:"count",value:function(e){try{e=r(e,this.arrayKeys),t.isUndefined(e)&&(e={});var n=this.nativeLokiCollection.find(e);return _Promise.resolve(n.length)}catch(i){return _Promise.reject(i)}}},{key:"updateMany",value:function(e,n){var i=this.nativeLokiCollection,r=this.idKey,o={};return o[r]={$in:e},new _Promise(function(r,u){try{i.chain().find(o).update(function(e){return t.isObject(n.$set)&&t.keys(n.$set).length>0&&(e=t.assign(e,n.$set)),t.isObject(n.$addToSet)&&t.keys(n.$addToSet).length>0&&t.forEach(n.$addToSet,function(n,i){t.isArray(e[i])||(e[i]=[]),e[i].push(n)}),e}),r({ok:1,nModified:e.length,n:e.length})}catch(a){u(a)}})}},{key:"incrementField",value:function(e,n,i){var r=this.nativeLokiCollection,u=this.idKey,a=o(u,e[u]);return this.findOne(a).then(function(o){if(t.isEmpty(o))throw new Error("unknown doc id: "+e[u]);return(t.isUndefined(o[n])||t.isNull(o[n]))&&(o[n]=0),o[n]=o[n]+i,r.update(o),t.assign({},o)})}}]),n}(n.Collection);e.LokiCollection=a;var s=function(e,n,i){var r=e[n];if(t.isUndefined(r)||t.isNull(r))return _Promise.resolve();if(t.isArray(r)){var o=function(){var o=r,u=[],a=t.map(o,function(e){return i.findById(e).then(function(e){if(!e)throw new Error("population  failed");u.push(e)})});return{v:_Promise.all(a).then(function(){return e[n]=u,e})}}();if("object"==typeof o)return o.v}return i.findById(r).then(function(t){if(!t)throw new Error("population  failed");e[n]=t})},l=function(e){function n(e){_classCallCheck(this,n),_get(Object.getPrototypeOf(n.prototype),"constructor",this).call(this),t.isString(e)&&(e=new i(e)),this.loki=e,this.collections={}}return _inherits(n,e),_createClass(n,[{key:"addCollection",value:function(e,n,i){var r=void 0;if(e instanceof a)r=e,e=r.name;else{if(!t.isString(e)||t.isEmpty(e))throw new Error("must provide a name when adding a collection");var o=this.loki.getCollection(e);o||(o=this.loki.addCollection(e)),t.isObject(o.constraints.unique[n])||o.ensureUniqueIndex(n),r=new a(e,o,n,i)}return this.collections[e]=r,r}},{key:"getCollection",value:function(e){if(!this.collections[e])throw new Error("unknown collection: "+e);return this.collections[e]}},{key:"getCollections",value:function(){return this.collections}},{key:"populate",value:function(e,n,i){var r=this;try{var o=function(){if(!e)return{v:_Promise.reject(new Error("tried to populate a null value"))};var o=r.getCollection(i);t.isArray(e)||(e=[e]);var u=t.map(e,function(e){return s(e,n,o)});return{v:_Promise.all(u).then(function(){return e})}}();if("object"==typeof o)return o.v}catch(u){return _Promise.reject(u)}}}]),n}(n.Adapter);e.LokiAdapter=l});
//# sourceMappingURL=jeggyloki.min.js.map
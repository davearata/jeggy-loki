var _get=require("babel-runtime/helpers/get")["default"],_inherits=require("babel-runtime/helpers/inherits")["default"],_createClass=require("babel-runtime/helpers/create-class")["default"],_classCallCheck=require("babel-runtime/helpers/class-call-check")["default"],_Promise=require("babel-runtime/core-js/promise")["default"];!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jeggy"),require("lodash"),require("lokijs")):"function"==typeof define&&define.amd?define(["exports","jeggy","lodash","lokijs"],t):t(e.jeggyloki={},e.jeggy,e._,e.Loki)}(this,function(e,t,n,i){"use strict";n="default"in n?n["default"]:n,i="default"in i?i["default"]:i;var r=function(e,t){if(e=n.reduce(e,function(e,i,r){return n.contains(t,r)?e[r]={$contains:i}:e[r]=i,e},{}),n.keys(e).length>1){var i=n.map(n.keys(e),function(t){var n={};return n[t]=e[t],n});e={$and:i}}return e},o=function(e,t){var n={};return n[e]=t,n},u=function(e,t){var i={},r=t.split(" ");return n.includes(t,"-")?(i=n.assign(i,e),n.each(r,function(e){n.includes(e,"-")&&(e=n.trim(e,"-"),i=n.omit(i,e))})):n.each(r,function(t){n.includes(t,"+")&&(t=n.trim(t,"+")),i[t]=e[t]}),i},a=function(e){function t(e,n,i,r){if(_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),!n)throw new Error("a LokiCollection must be intiialized with a native lokiJS collection");this.nativeLokiCollection=n,this.idKey=i||"_id",this.arrayKeys=r}return _inherits(t,e),_createClass(t,[{key:"find",value:function(e,t){var i=this.nativeLokiCollection,o=this.arrayKeys;return new _Promise(function(a,l){try{e=r(e,o),n.isUndefined(e)&&(e={});var s=i.find(e);null!==s&&(s=n.clone(s,!0),n.isString(t)&&(s=n.map(s,function(e){return u(e,t)}))),a(s)}catch(c){l(c)}})}},{key:"findOne",value:function(e,t){return this.find(e,t).then(function(e){return n.isArray(e)&&(e=e[0]),e})}},{key:"findById",value:function(e,t){var n=o(this.idKey,e);return this.findOne(n,t)}},{key:"create",value:function(e){var t=this.nativeLokiCollection;return new _Promise(function(i,r){try{var o=t.insert(e);if(null===o)return i(o);i(n.assign({},o))}catch(u){r(u)}})}},{key:"removeWhere",value:function(e){var t=this.nativeLokiCollection,n=this.arrayKeys;return new _Promise(function(i,o){try{e=r(e,n),i(t.removeWhere(e))}catch(u){o(u)}})}},{key:"remove",value:function(e){var t=this.nativeLokiCollection,i=o(this.idKey,e[this.idKey]);return new _Promise(function(r,o){try{var u=n.assign({},t.findOne(i));n.isEmpty(u)&&o(new Error("unknown doc id:"+e.id)),r(t.remove(e))}catch(a){o(a)}})}},{key:"update",value:function(e){var t=this.nativeLokiCollection,i=this.idKey,r=o(i,e[i]);return this.findOne(r).then(function(r){if(n.isEmpty(r))throw new Error("unknown doc id:"+e[i]);return r=n.assign(r,e),t.update(r),n.assign({},r)})}}]),t}(t.Collection);e.LokiCollection=a;var l=function(e,t,i){var r=e[t];if(n.isUndefined(r)||n.isNull(r))return _Promise.resolve();if(n.isArray(r)){var o=function(){var o=r,u=[],a=n.map(o,function(e){return i.findById(e).then(function(e){if(!e)throw new Error("population  failed");u.push(e)})});return{v:_Promise.all(a).then(function(){return e[t]=u,e})}}();if("object"==typeof o)return o.v}return i.findById(r).then(function(n){if(!n)throw new Error("population  failed");e[t]=n})},s=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),n.isString(e)&&(e=new i(e)),this.loki=e,this.collections={}}return _inherits(t,e),_createClass(t,[{key:"addCollection",value:function(e,t,i){var r=void 0;if(e instanceof a)r=e,e=r.name;else{if(!n.isString(e)||n.isEmpty(e))throw new Error("must provide a name when adding a collection");var o=this.loki.addCollection(e);r=new a(e,o,t,i)}return this.collections[e]=r,r}},{key:"getCollection",value:function(e){if(!this.collections[e])throw new Error("unknown collection: "+e);return this.collections[e]}},{key:"getCollections",value:function(){return this.collections}},{key:"populate",value:function(e,t,i){var r=this;try{var o=function(){if(!e)return{v:_Promise.reject(new Error("tried to populate a null value"))};var o=r.getCollection(i);n.isArray(e)||(e=[e]);var u=n.map(e,function(e){return l(e,t,o)});return{v:_Promise.all(u).then(function(){return e})}}();if("object"==typeof o)return o.v}catch(u){return _Promise.reject(u)}}}]),t}(t.Adapter);e.LokiAdapter=s});
//# sourceMappingURL=jeggyloki.min.js.map
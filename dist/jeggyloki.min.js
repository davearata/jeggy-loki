var _get=require("babel-runtime/helpers/get")["default"],_inherits=require("babel-runtime/helpers/inherits")["default"],_createClass=require("babel-runtime/helpers/create-class")["default"],_classCallCheck=require("babel-runtime/helpers/class-call-check")["default"],_regeneratorRuntime=require("babel-runtime/regenerator")["default"],_Promise=require("babel-runtime/core-js/promise")["default"];!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jeggy"),require("lodash"),require("co"),require("lokijs")):"function"==typeof define&&define.amd?define(["exports","jeggy","lodash","co","lokijs"],t):t(e.jeggyloki={},e.jeggy,e._,e.co,e.Loki)}(this,function(e,t,r,n,i){"use strict";r="default"in r?r["default"]:r,n="default"in n?n["default"]:n,i="default"in i?i["default"]:i;var o=function(e){if(r.keys(e).length>1){var t=r.map(r.keys(e),function(t){var r={};return r[t]=e[t],r});e={$and:t}}return e},u=function(e,t){var r={};return r[e]=t,r},a=function(e,t){var n={},i=t.split(" ");return r.includes(t,"-")?(n=r.assign(n,e),r.each(i,function(e){r.includes(e,"-")&&(e=r.trim(e,"-"),n=r.omit(n,e))})):r.each(i,function(t){r.includes(t,"+")&&(t=r.trim(t,"+")),n[t]=e[t]}),n},s=function(e){function t(e,r,n){if(_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),!r)throw new Error("a LokiCollection must be intiialized with a native lokiJS collection");this.nativeLokiCollection=r,this.idKey=n||"_id"}return _inherits(t,e),_createClass(t,[{key:"find",value:function(e,t){var i=this.nativeLokiCollection;return n(_regeneratorRuntime.mark(function u(){var n;return _regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return e=o(e),r.isUndefined(e)&&(e={}),n=i.find(e),null!==n&&(n=r.clone(n,!0),r.isString(t)&&(n=r.map(n,function(e){return a(e,t)}))),u.abrupt("return",n);case 5:case"end":return u.stop()}},u,this)}))}},{key:"findOne",value:function(e,t){var i=this.nativeLokiCollection;return n(_regeneratorRuntime.mark(function u(){var n;return _regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(e=o(e),r.isUndefined(e)&&(e={}),n=i.find(e),null!==n&&!r.isEmpty(n)){u.next=5;break}return u.abrupt("return",null);case 5:return r.isArray(n)&&(n=n[0]),n=r.assign({},n),r.isString(t)&&r.isObject(n)&&(n=a(n,t)),u.abrupt("return",n);case 9:case"end":return u.stop()}},u,this)}))}},{key:"findById",value:function(e,t){var r=u(this.idKey,e);return this.findOne(r,t)}},{key:"create",value:function(e){var t=this.nativeLokiCollection;return n(_regeneratorRuntime.mark(function i(){var n;return _regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(n=t.insert(e),null!==n){i.next=3;break}return i.abrupt("return",n);case 3:return i.abrupt("return",r.assign({},n));case 4:case"end":return i.stop()}},i,this)}))}},{key:"removeWhere",value:function(e){var t=this.nativeLokiCollection;return n(_regeneratorRuntime.mark(function r(){return _regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return e=o(e),r.abrupt("return",t.removeWhere(e));case 2:case"end":return r.stop()}},r,this)}))}},{key:"remove",value:function(e){var t=this.nativeLokiCollection,i=u(this.idKey,e[this.idKey]);return n(_regeneratorRuntime.mark(function o(){var n;return _regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(n=r.assign({},t.findOne(i)),!r.isEmpty(n)){o.next=3;break}throw new Error("unknown doc id:"+e.id);case 3:return o.abrupt("return",t.remove(e));case 4:case"end":return o.stop()}},o,this)}))}},{key:"update",value:function(e){var t=this.nativeLokiCollection,n=u(this.idKey,e[this.idKey]);return this.findOne(n).then(function(n){if(r.isEmpty(n))throw new Error("unknown doc id:"+e.id);return n=r.merge(n,e),t.update(n),r.assign({},n)})}}]),t}(t.Collection);e.LokiCollection=s;var c=function(e,t,n){var i=e[t];if(r.isUndefined(i))throw new Error("Unknown field: "+t);if(r.isArray(i)){var o=function(){var o=i,u=[],a=r.map(o,function(e){return n.findById(e).then(function(e){if(!e)throw new Error("population  failed");u.push(e)})});return{v:_Promise.all(a).then(function(){return e[t]=u,e})}}();if("object"==typeof o)return o.v}return n.findById(i).then(function(r){if(!r)throw new Error("population  failed");e[t]=r})},l=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),r.isString(e)&&(e=new i(e)),this.loki=e,this.collections={}}return _inherits(t,e),_createClass(t,[{key:"addCollection",value:function(e,t){var n=void 0;if(e instanceof s)n=e,e=n.name;else{if(!r.isString(e)||r.isEmpty(e))throw new Error("must provide a name when adding a collection");var i=this.loki.addCollection(e);n=new s(e,i,t)}return this.collections[e]=n,n}},{key:"getCollection",value:function(e){if(!this.collections[e])throw new Error("unknown collection: "+e);return this.collections[e]}},{key:"getCollections",value:function(){return this.collections}},{key:"populate",value:function(e,t,i){var o=this.getCollection.bind(this);return n(_regeneratorRuntime.mark(function u(){var n,a;return _regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(e){u.next=2;break}throw new Error("tried to populate a null value");case 2:return n=o(i),r.isArray(e)||(e=[e]),a=r.map(e,function(e){return c(e,t,n)}),u.abrupt("return",_Promise.all(a).then(function(){return e}));case 6:case"end":return u.stop()}},u,this)}))}}]),t}(t.Adapter);e.LokiAdapter=l});
//# sourceMappingURL=jeggyloki.min.js.map
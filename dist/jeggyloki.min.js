var _get=require("babel-runtime/helpers/get")["default"],_inherits=require("babel-runtime/helpers/inherits")["default"],_createClass=require("babel-runtime/helpers/create-class")["default"],_classCallCheck=require("babel-runtime/helpers/class-call-check")["default"],_Promise=require("babel-runtime/core-js/promise")["default"];!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jeggy"),require("lodash"),require("lokijs")):"function"==typeof define&&define.amd?define(["exports","jeggy","lodash","lokijs"],t):t(e.jeggyloki={},e.jeggy,e._,e.Loki)}(this,function(e,t,n,i){"use strict";n="default"in n?n["default"]:n,i="default"in i?i["default"]:i;var r=function(e,t){if(e=n.reduce(e,function(e,i,r){return n.contains(t,r)?n.isArray(i)?e[r]={$containsAny:i}:e[r]={$contains:i}:e[r]=i,e},{}),n.keys(e).length>1){var i=n.map(n.keys(e),function(t){var n={};return n[t]=e[t],n});e={$and:i}}return e},o=function(e,t){var n={};return n[e]=t,n},u=function(e,t){var i={},r=t.split(" ");return n.includes(t,"-")?(i=n.assign(i,e),n.each(r,function(e){n.includes(e,"-")&&(e=n.trim(e,"-"),i=n.omit(i,e))})):n.each(r,function(t){n.includes(t,"+")&&(t=n.trim(t,"+")),i[t]=e[t]}),i},s=function(e){function t(e,n,i,r){if(_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e),!n)throw new Error("a LokiCollection must be intiialized with a native lokiJS collection");this.nativeLokiCollection=n,this.idKey=i||"_id",this.arrayKeys=r}return _inherits(t,e),_createClass(t,[{key:"aggregate",value:function(){throw new Error("jeggy-loki does not yet support this functionality")}},{key:"addToSet",value:function(e,t,i){n.isArray(e[t])||(e[t]=[]);var r=i;n.isObject(i)&&(r=JSON.stringify(i));var o=n.find(e[t],function(e){return n.isObject(e)&&(e=JSON.stringify(e)),e===r});return n.isUndefined(o)?(e[t].push(i),this.update(e)):_Promise.resolve(e)}},{key:"pull",value:function(e,t){var i=n.keys(t)[0],r=t[i];return e[i]=n.filter(e[i],function(e){return e.toString()!==r.toString()}),this.update(e)}},{key:"find",value:function(e,t){var i=this.nativeLokiCollection,o=this.arrayKeys;return new _Promise(function(s,a){try{e=r(e,o),n.isUndefined(e)&&(e={});var l=i.find(e);null!==l&&(n.isString(t)&&(l=n.map(l,function(e){return u(e,t)})),l=n.clone(l,!0)),s(l)}catch(c){a(c)}})}},{key:"findStream",value:function(){throw new Error("jeggy-loki does not yet support this functionality")}},{key:"findOne",value:function(e,t){return this.find(e,t).then(function(e){return n.isArray(e)&&(e=e[0]),e})}},{key:"findById",value:function(e,t){var n=o(this.idKey,e);return this.findOne(n,t)}},{key:"create",value:function(e){var t=this.nativeLokiCollection;return new _Promise(function(i,r){try{var o=t.insert(e);if(null===o)return i(o);i(n.assign({},o))}catch(u){r(u)}})}},{key:"insertMany",value:function(e){var t=this.nativeLokiCollection;return new _Promise(function(i,r){try{var o=t.insert(e);if(null===o)return i(o);i(n.clone(o,!0))}catch(u){r(u)}})}},{key:"removeWhere",value:function(e){var t=this.nativeLokiCollection,n=this.arrayKeys;return new _Promise(function(i,o){try{e=r(e,n),i(t.removeWhere(e))}catch(u){o(u)}})}},{key:"remove",value:function(e){var t=this.nativeLokiCollection,i=o(this.idKey,e[this.idKey]);return new _Promise(function(r,o){try{var u=n.assign({},t.findOne(i));n.isEmpty(u)&&o(new Error("unknown doc id:"+e.id)),r(t.remove(e))}catch(s){o(s)}})}},{key:"update",value:function(e){var t=this.nativeLokiCollection,i=this.idKey,r=o(i,e[i]);return this.findOne(r).then(function(r){if(n.isEmpty(r))throw new Error("unknown doc id: "+e[i]);return r=n.assign(r,e),t.update(r),n.assign({},r)})}},{key:"count",value:function(e){try{e=r(e,this.arrayKeys),n.isUndefined(e)&&(e={});var t=this.nativeLokiCollection.find(e);return _Promise.resolve(t.length)}catch(i){return _Promise.reject(i)}}},{key:"updateMany",value:function(e,t){var i=this.nativeLokiCollection,r=this.idKey,o={};return o[r]={$in:e},new _Promise(function(r,u){try{i.chain().find(o).update(function(e){return n.isObject(t.$set)&&n.keys(t.$set).length>0&&(e=n.assign(e,t.$set)),n.isObject(t.$addToSet)&&n.keys(t.$addToSet).length>0&&n.forEach(t.$addToSet,function(t,i){n.isArray(e[i])||(e[i]=[]),e[i].push(t)}),e}),r({ok:1,nModified:e.length,n:e.length})}catch(s){u(s)}})}},{key:"incrementField",value:function(e,t,i){var r=this.nativeLokiCollection,u=this.idKey,s=o(u,e[u]);return this.findOne(s).then(function(o){if(n.isEmpty(o))throw new Error("unknown doc id: "+e[u]);return(n.isUndefined(o[t])||n.isNull(o[t]))&&(o[t]=0),o[t]=o[t]+i,r.update(o),n.assign({},o)})}}]),t}(t.Collection);e.LokiCollection=s;var a=function(e,t,i){var r=e[t];if(n.isUndefined(r)||n.isNull(r))return _Promise.resolve();if(n.isArray(r)){var o=function(){var o=r,u=[],s=n.map(o,function(e){return i.findById(e).then(function(e){if(!e)throw new Error("population  failed");u.push(e)})});return{v:_Promise.all(s).then(function(){return e[t]=u,e})}}();if("object"==typeof o)return o.v}return i.findById(r).then(function(n){if(!n)throw new Error("population  failed");e[t]=n})},l=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),n.isString(e)&&(e=new i(e)),this.loki=e,this.collections={}}return _inherits(t,e),_createClass(t,[{key:"addCollection",value:function(e,t,i){var r=void 0;if(e instanceof s)r=e,e=r.name;else{if(!n.isString(e)||n.isEmpty(e))throw new Error("must provide a name when adding a collection");var o=this.loki.getCollection(e);o||(o=this.loki.addCollection(e)),n.isObject(o.constraints.unique[t])||o.ensureUniqueIndex(t),r=new s(e,o,t,i)}return this.collections[e]=r,r}},{key:"getCollection",value:function(e){if(!this.collections[e])throw new Error("unknown collection: "+e);return this.collections[e]}},{key:"getCollections",value:function(){return this.collections}},{key:"populate",value:function(e,t,i){var r=this;try{var o=function(){if(!e)return{v:_Promise.reject(new Error("tried to populate a null value"))};var o=r.getCollection(i);n.isArray(e)||(e=[e]);var u=n.map(e,function(e){return a(e,t,o)});return{v:_Promise.all(u).then(function(){return e})}}();if("object"==typeof o)return o.v}catch(u){return _Promise.reject(u)}}}]),t}(t.Adapter);e.LokiAdapter=l});
//# sourceMappingURL=jeggyloki.min.js.map
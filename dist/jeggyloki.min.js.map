{"version":3,"file":"jeggyloki.js","sources":["jeggyloki.js","/source/jeggyloki.js"],"names":["global","factory","exports","module","require","define","amd","jeggyloki","jeggy","_","Loki","this","buildLokiQuery","query","arrayKeys","reduce","result","value","key","contains","isArray","$containsAny","$contains","keys","length","queryArray","map","queryKey","$and","buildLokiIdQuery","idKey","id","applyProjection","doc","projection","projectionArr","split","includes","assign","each","projectionKey","trim","omit","LokiCollection","_jeggy$Collection","name","nativeLokiCollection","_get","Object","getPrototypeOf","prototype","call","Error","_Promise","resolve","reject","isUndefined","find","clone","isString","error","then","findOne","createdDoc","insert","docs","createdDocs","removeWhere","foundDoc","isEmpty","remove","update","ids","$in","chain","obj","isObject","$set","$addToSet","forEach","push","ok","nModified","n","err","Collection","populateDoc","fieldKey","collection","isNull","array","populatedArray","promises","itemId","findById","all","LokiAdapter","_jeggy$Adapter","loki","collections","undefined","lokiCollection","getCollection","addCollection","collectionName","_this","Adapter"],"mappings":"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","sourceRoot":"/source/","sourcesContent":["(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('jeggy'), require('lodash'), require('lokijs')) :\n  typeof define === 'function' && define.amd ? define(['exports', 'jeggy', 'lodash', 'lokijs'], factory) :\n  factory((global.jeggyloki = {}), global.jeggy, global._, global.Loki)\n}(this, function (exports, jeggy, _, Loki) { 'use strict';\n\n  _ = ('default' in _ ? _['default'] : _);\n  Loki = ('default' in Loki ? Loki['default'] : Loki);\n\n  const buildLokiQuery = function buildLokiQuery(query, arrayKeys) {\n    query = _.reduce(query, (result, value, key) => {\n      if(_.contains(arrayKeys, key)) {\n        if(_.isArray(value)) {\n          result[key] = {$containsAny: value};\n        } else {\n          result[key] = {$contains: value};\n        }\n      } else {\n        result[key] = value;\n      }\n      return result;\n    }, {});\n\n    if (_.keys(query).length > 1) {\n      const queryArray = _.map(_.keys(query), (queryKey) => {\n        const result = {};\n        result[queryKey] = query[queryKey];\n        return result;\n      });\n      query = {$and: queryArray};\n    }\n    return query;\n  };\n\n  const buildLokiIdQuery = function buildLokiIdQuery(idKey, id) {\n    const query = {};\n    query[idKey] = id;\n    return query;\n  };\n\n  const applyProjection = function applyProjection(doc, projection) {\n    let result = {};\n    const projectionArr = projection.split(' ');\n    if (_.includes(projection, '-')) {\n      //take all fields excepts ones excluded\n      result = _.assign(result, doc);\n      _.each(projectionArr, (projectionKey) => {\n        if (_.includes(projectionKey, '-')) {\n          projectionKey = _.trim(projectionKey, '-');\n          result = _.omit(result, projectionKey);\n        }\n      });\n    } else {\n      //only take fields specified\n      _.each(projectionArr, (projectionKey) => {\n        if (_.includes(projectionKey, '+')) {\n          projectionKey = _.trim(projectionKey, '+');\n        }\n        result[projectionKey] = doc[projectionKey];\n      });\n    }\n\n    return result;\n  };\n\n  class LokiCollection extends jeggy.Collection {\n    constructor(name, nativeLokiCollection, idKey, arrayKeys) {\n      super(name);\n      if (!nativeLokiCollection) {\n        throw new Error('a LokiCollection must be intiialized with a native lokiJS collection');\n      }\n      this.nativeLokiCollection = nativeLokiCollection;\n      this.idKey = idKey || '_id';\n      this.arrayKeys = arrayKeys;\n    }\n\n    find(query, projection) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const arrayKeys = this.arrayKeys;\n      return new Promise((resolve, reject) => {\n        try {\n          query = buildLokiQuery(query, arrayKeys);\n          if (_.isUndefined(query)) {\n            query = {};\n          }\n          let result = nativeLokiCollection.find(query);\n          if (result !== null) {\n            result = _.clone(result, true);\n            if (_.isString(projection)) {\n              result = _.map(result, (doc) => {\n                return applyProjection(doc, projection);\n              });\n            }\n          }\n          resolve(result);\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    findOne(query, projection) {\n      return this.find(query, projection)\n        .then(result => {\n          if (_.isArray(result)) {\n            result = result[0];\n          }\n\n          return result;\n        });\n    }\n\n    findById(id, projection) {\n      const query = buildLokiIdQuery(this.idKey, id);\n      return this.findOne(query, projection);\n    }\n\n    create(doc) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      return new Promise((resolve, reject) => {\n        try {\n          const createdDoc = nativeLokiCollection.insert(doc);\n          if (createdDoc === null) {\n            return resolve(createdDoc);\n          }\n          resolve(_.assign({}, createdDoc));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    insertMany(docs) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      return new Promise((resolve, reject) => {\n        try {\n          const createdDocs = nativeLokiCollection.insert(docs);\n          if (createdDocs === null) {\n            return resolve(createdDocs);\n          }\n          resolve(_.clone(createdDocs, true));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    removeWhere(query) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const arrayKeys = this.arrayKeys;\n      return new Promise((resolve, reject) => {\n        try {\n          query = buildLokiQuery(query, arrayKeys);\n          resolve(nativeLokiCollection.removeWhere(query));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    remove(doc) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const query = buildLokiIdQuery(this.idKey, doc[this.idKey]);\n      return new Promise((resolve, reject) => {\n        try {\n          const foundDoc = _.assign({}, nativeLokiCollection.findOne(query));\n          if (_.isEmpty(foundDoc)) {\n            reject(new Error('unknown doc id:' + doc.id));\n          }\n          resolve(nativeLokiCollection.remove(doc));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    update(doc) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const idKey = this.idKey;\n      const query = buildLokiIdQuery(idKey, doc[idKey]);\n      return this.findOne(query)\n        .then(foundDoc => {\n          if (_.isEmpty(foundDoc)) {\n            throw new Error('unknown doc id:' + doc[idKey]);\n          }\n\n          foundDoc = _.assign(foundDoc, doc);\n          nativeLokiCollection.update(foundDoc);\n          return _.assign({}, foundDoc);\n        });\n    }\n\n    updateMany(ids, update) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const idKey = this.idKey;\n      const query = {};\n      query[idKey] = {$in: ids};\n      return new Promise((resolve, reject) => {\n        try {\n          nativeLokiCollection\n            .chain()\n            .find(query)\n            .update(obj => {\n              if(_.isObject(update.$set) && _.keys(update.$set).length > 0) {\n                obj = _.assign(obj, update.$set);\n              }\n              if(_.isObject(update.$addToSet) && _.keys(update.$addToSet).length > 0) {\n                _.forEach(update.$addToSet, (value, key) => {\n                  if(!_.isArray(obj[key])) {\n                    obj[key] = [];\n                  }\n                  obj[key].push(value);\n                });\n              }\n              return obj;\n            });\n          resolve({ok: 1, nModified: ids.length, n: ids.length});\n        } catch (err) {\n          reject(err);\n        }\n      });\n    }\n  }\n\n  exports.LokiCollection = LokiCollection;\n\n  const populateDoc = function populateDoc(doc, fieldKey, collection) {\n    const id = doc[fieldKey];\n    if (_.isUndefined(id) || _.isNull(id)) {\n      return Promise.resolve();\n    }\n\n    if (_.isArray(id)) {\n      const array = id;\n      const populatedArray = [];\n      const promises = _.map(array, (itemId) => {\n        return collection.findById(itemId)\n          .then((foundDoc) => {\n            if (!foundDoc) {\n              throw new Error('population  failed');\n            }\n\n            populatedArray.push(foundDoc);\n          });\n      });\n      return Promise.all(promises)\n        .then(() => {\n          doc[fieldKey] = populatedArray;\n          return doc;\n        });\n    }\n\n    return collection.findById(id)\n      .then((foundDoc) => {\n        if (!foundDoc) {\n          throw new Error('population  failed');\n        }\n\n        doc[fieldKey] = foundDoc;\n      });\n  };\n\n  class LokiAdapter extends jeggy.Adapter {\n    constructor(loki) {\n      super();\n      if (_.isString(loki)) {\n        loki = new Loki(loki);\n      }\n\n      this.loki = loki;\n      this.collections = {};\n    }\n\n    addCollection(name, idKey, arrayKeys) {\n      let collection;\n      if (name instanceof LokiCollection) {\n        collection = name;\n        name = collection.name;\n      } else {\n        if (!_.isString(name) || _.isEmpty(name)) {\n          throw new Error('must provide a name when adding a collection');\n        }\n        let lokiCollection = this.loki.getCollection(name);\n        if(!lokiCollection) {\n          lokiCollection = this.loki.addCollection(name);\n        }\n        collection = new LokiCollection(name, lokiCollection, idKey, arrayKeys);\n      }\n\n      this.collections[name] = collection;\n      return collection;\n    }\n\n    getCollection(name) {\n      if (!this.collections[name]) {\n        throw new Error('unknown collection: ' + name);\n      }\n      return this.collections[name];\n    }\n\n    getCollections() {\n      return this.collections;\n    }\n\n    populate(docs, fieldKey, collectionName) {\n      try {\n        if (!docs) {\n          return Promise.reject(new Error('tried to populate a null value'));\n        }\n\n        const collection = this.getCollection(collectionName);\n\n        if (!_.isArray(docs)) {\n          docs = [docs];\n        }\n\n        const promises = _.map(docs, doc => {\n          return populateDoc(doc, fieldKey, collection);\n        });\n\n        return Promise.all(promises)\n          .then(() => {\n            return docs;\n          });\n      } catch (error) {\n        return Promise.reject(error);\n      }\n    }\n  }\n\n  exports.LokiAdapter = LokiAdapter;\n\n\n\n}));\n","(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('jeggy'), require('lodash'), require('lokijs')) :\n  typeof define === 'function' && define.amd ? define(['exports', 'jeggy', 'lodash', 'lokijs'], factory) :\n  factory((global.jeggyloki = {}), global.jeggy, global._, global.Loki)\n}(this, function (exports, jeggy, _, Loki) { 'use strict';\n\n  _ = ('default' in _ ? _['default'] : _);\n  Loki = ('default' in Loki ? Loki['default'] : Loki);\n\n  const buildLokiQuery = function buildLokiQuery(query, arrayKeys) {\n    query = _.reduce(query, (result, value, key) => {\n      if(_.contains(arrayKeys, key)) {\n        if(_.isArray(value)) {\n          result[key] = {$containsAny: value};\n        } else {\n          result[key] = {$contains: value};\n        }\n      } else {\n        result[key] = value;\n      }\n      return result;\n    }, {});\n\n    if (_.keys(query).length > 1) {\n      const queryArray = _.map(_.keys(query), (queryKey) => {\n        const result = {};\n        result[queryKey] = query[queryKey];\n        return result;\n      });\n      query = {$and: queryArray};\n    }\n    return query;\n  };\n\n  const buildLokiIdQuery = function buildLokiIdQuery(idKey, id) {\n    const query = {};\n    query[idKey] = id;\n    return query;\n  };\n\n  const applyProjection = function applyProjection(doc, projection) {\n    let result = {};\n    const projectionArr = projection.split(' ');\n    if (_.includes(projection, '-')) {\n      //take all fields excepts ones excluded\n      result = _.assign(result, doc);\n      _.each(projectionArr, (projectionKey) => {\n        if (_.includes(projectionKey, '-')) {\n          projectionKey = _.trim(projectionKey, '-');\n          result = _.omit(result, projectionKey);\n        }\n      });\n    } else {\n      //only take fields specified\n      _.each(projectionArr, (projectionKey) => {\n        if (_.includes(projectionKey, '+')) {\n          projectionKey = _.trim(projectionKey, '+');\n        }\n        result[projectionKey] = doc[projectionKey];\n      });\n    }\n\n    return result;\n  };\n\n  class LokiCollection extends jeggy.Collection {\n    constructor(name, nativeLokiCollection, idKey, arrayKeys) {\n      super(name);\n      if (!nativeLokiCollection) {\n        throw new Error('a LokiCollection must be intiialized with a native lokiJS collection');\n      }\n      this.nativeLokiCollection = nativeLokiCollection;\n      this.idKey = idKey || '_id';\n      this.arrayKeys = arrayKeys;\n    }\n\n    find(query, projection) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const arrayKeys = this.arrayKeys;\n      return new Promise((resolve, reject) => {\n        try {\n          query = buildLokiQuery(query, arrayKeys);\n          if (_.isUndefined(query)) {\n            query = {};\n          }\n          let result = nativeLokiCollection.find(query);\n          if (result !== null) {\n            result = _.clone(result, true);\n            if (_.isString(projection)) {\n              result = _.map(result, (doc) => {\n                return applyProjection(doc, projection);\n              });\n            }\n          }\n          resolve(result);\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    findOne(query, projection) {\n      return this.find(query, projection)\n        .then(result => {\n          if (_.isArray(result)) {\n            result = result[0];\n          }\n\n          return result;\n        });\n    }\n\n    findById(id, projection) {\n      const query = buildLokiIdQuery(this.idKey, id);\n      return this.findOne(query, projection);\n    }\n\n    create(doc) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      return new Promise((resolve, reject) => {\n        try {\n          const createdDoc = nativeLokiCollection.insert(doc);\n          if (createdDoc === null) {\n            return resolve(createdDoc);\n          }\n          resolve(_.assign({}, createdDoc));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    insertMany(docs) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      return new Promise((resolve, reject) => {\n        try {\n          const createdDocs = nativeLokiCollection.insert(docs);\n          if (createdDocs === null) {\n            return resolve(createdDocs);\n          }\n          resolve(_.clone(createdDocs, true));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    removeWhere(query) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const arrayKeys = this.arrayKeys;\n      return new Promise((resolve, reject) => {\n        try {\n          query = buildLokiQuery(query, arrayKeys);\n          resolve(nativeLokiCollection.removeWhere(query));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    remove(doc) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const query = buildLokiIdQuery(this.idKey, doc[this.idKey]);\n      return new Promise((resolve, reject) => {\n        try {\n          const foundDoc = _.assign({}, nativeLokiCollection.findOne(query));\n          if (_.isEmpty(foundDoc)) {\n            reject(new Error('unknown doc id:' + doc.id));\n          }\n          resolve(nativeLokiCollection.remove(doc));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    update(doc) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const idKey = this.idKey;\n      const query = buildLokiIdQuery(idKey, doc[idKey]);\n      return this.findOne(query)\n        .then(foundDoc => {\n          if (_.isEmpty(foundDoc)) {\n            throw new Error('unknown doc id:' + doc[idKey]);\n          }\n\n          foundDoc = _.assign(foundDoc, doc);\n          nativeLokiCollection.update(foundDoc);\n          return _.assign({}, foundDoc);\n        });\n    }\n\n    updateMany(ids, update) {\n      const nativeLokiCollection = this.nativeLokiCollection;\n      const idKey = this.idKey;\n      const query = {};\n      query[idKey] = {$in: ids};\n      return new Promise((resolve, reject) => {\n        try {\n          nativeLokiCollection\n            .chain()\n            .find(query)\n            .update(obj => {\n              if(_.isObject(update.$set) && _.keys(update.$set).length > 0) {\n                obj = _.assign(obj, update.$set);\n              }\n              if(_.isObject(update.$addToSet) && _.keys(update.$addToSet).length > 0) {\n                _.forEach(update.$addToSet, (value, key) => {\n                  if(!_.isArray(obj[key])) {\n                    obj[key] = [];\n                  }\n                  obj[key].push(value);\n                });\n              }\n              return obj;\n            });\n          resolve({ok: 1, nModified: ids.length, n: ids.length});\n        } catch (err) {\n          reject(err);\n        }\n      });\n    }\n  }\n\n  exports.LokiCollection = LokiCollection;\n\n  const populateDoc = function populateDoc(doc, fieldKey, collection) {\n    const id = doc[fieldKey];\n    if (_.isUndefined(id) || _.isNull(id)) {\n      return Promise.resolve();\n    }\n\n    if (_.isArray(id)) {\n      const array = id;\n      const populatedArray = [];\n      const promises = _.map(array, (itemId) => {\n        return collection.findById(itemId)\n          .then((foundDoc) => {\n            if (!foundDoc) {\n              throw new Error('population  failed');\n            }\n\n            populatedArray.push(foundDoc);\n          });\n      });\n      return Promise.all(promises)\n        .then(() => {\n          doc[fieldKey] = populatedArray;\n          return doc;\n        });\n    }\n\n    return collection.findById(id)\n      .then((foundDoc) => {\n        if (!foundDoc) {\n          throw new Error('population  failed');\n        }\n\n        doc[fieldKey] = foundDoc;\n      });\n  };\n\n  class LokiAdapter extends jeggy.Adapter {\n    constructor(loki) {\n      super();\n      if (_.isString(loki)) {\n        loki = new Loki(loki);\n      }\n\n      this.loki = loki;\n      this.collections = {};\n    }\n\n    addCollection(name, idKey, arrayKeys) {\n      let collection;\n      if (name instanceof LokiCollection) {\n        collection = name;\n        name = collection.name;\n      } else {\n        if (!_.isString(name) || _.isEmpty(name)) {\n          throw new Error('must provide a name when adding a collection');\n        }\n        let lokiCollection = this.loki.getCollection(name);\n        if(!lokiCollection) {\n          lokiCollection = this.loki.addCollection(name);\n        }\n        collection = new LokiCollection(name, lokiCollection, idKey, arrayKeys);\n      }\n\n      this.collections[name] = collection;\n      return collection;\n    }\n\n    getCollection(name) {\n      if (!this.collections[name]) {\n        throw new Error('unknown collection: ' + name);\n      }\n      return this.collections[name];\n    }\n\n    getCollections() {\n      return this.collections;\n    }\n\n    populate(docs, fieldKey, collectionName) {\n      try {\n        if (!docs) {\n          return Promise.reject(new Error('tried to populate a null value'));\n        }\n\n        const collection = this.getCollection(collectionName);\n\n        if (!_.isArray(docs)) {\n          docs = [docs];\n        }\n\n        const promises = _.map(docs, doc => {\n          return populateDoc(doc, fieldKey, collection);\n        });\n\n        return Promise.all(promises)\n          .then(() => {\n            return docs;\n          });\n      } catch (error) {\n        return Promise.reject(error);\n      }\n    }\n  }\n\n  exports.LokiAdapter = LokiAdapter;\n\n\n\n}));\n"]}